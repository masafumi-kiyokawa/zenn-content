---
title: "新しいお仕事先のPythonの開発環境を多分改善した話"
emoji: "🪿"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["python", "venv", "uv", "ruff"]
published: false
---

# 要約
uvを紹介、サンプルと使い方をまとめて提供し、採用してもらえました

- [uv(公式)](https://docs.astral.sh/uv/)

# 前置き
個人的な話ですが、2025年3月で前の会社を退職し、4月からフリーランスとしてのお仕事を始めました。
フリーといってもやっていることはSESと同じで、個人で業務委託を受けて客先常駐で開発をしているという感じです。

内容としては業務効率化ツール作成やデータ加工などの依頼をもらって、開発、提出するということをやっています。
上長が1名いて、その方経由で僕にタスクが回ってくるという2名体制です。

# 課題感と当時の状況
Pythonやライブラリのバージョンを管理・把握しきれていないという課題感を参画直後に伝えてもらっており、仮想環境によるPythonバージョン固定を試み始めているという段階ということを聞いていました。

実際に開発済みのツールを見てみると、確かにREADMEの記載やrequirements等はなく、作成された仮想環境が保存されているわけでもありませんでした。
使用しているPythonバージョンもまちまちで、少し手直しして使うのにも一苦労するような状態です。

# 取り組んだこと
以前からuvの存在自体は知っていたのですが、いきなり「uv便利ですよ！」と紹介するのではなく、段階的に整えて共有/提案していくことにしました。
理由は色々ありますが、一番は各方法のメリットデメリットを感じてもらいやすい=どれを採用するかの判断がしやすいと考えたからです。
わりとレガシーな環境ということもあり、この段階ではuvが不採用となることも可能性として見込んでいました。

## １段階目
まずはツールごと、プロジェクトごとに仮想環境を作成し、requirements.txtに依存ライブラリを記載してインストール、ロックファイルを作成するようにしました。
また、併せてREADMEに仮想環境の作成手順やライブラリをの追加手順もまとめておくことで、Pythonバージョンやどのように開発作業を行なったかがわかるようにしました。

以下Windowsでコマンドプロンプトを使用することを前提としたREADMEの例です。
OSやshellが違う場合、Pythonバージョンの指定方法や仮想環境有効化のコマンドあたりが違うと思います。
```md
~~前略~~

# 仮想環境
## 作成
py -3.x -m venv .venv

## 有効化
.\.venv\Scripts\acrivate

## 無効化
deactivate

~~中略~~

# 依存関係
## 初回実行時
1. 仮想環境を作成、有効化
py -3.11 -m venv .venv
.\.venv\Scripts\acrivate

2. ライブラリインストール
pip install -r requirements.lock

## ライブラリ追加
1. 仮想環境の再作成
pip freeze > uninstall.txt
pip uninstall -r uninstall.txt
pip list

または`.venv`を一度削除、再作成する

2. requirements.txt更新
事前に既存依存ライブラリへのバージョン影響を確認する
問題なさそうなら追加するライブラリを`requirements.txt`に追記

3. インストール
pip install -r requirements.txt
pip check

4. ロックファイル作成
pip freeze > requirements.lock

~~後略~~

```

手元にWindowsPCがないので完全記憶のみでコマンド書きました。
間違ってたら治しますので教えてください。

- [venv(公式)](https://docs.python.org/ja/3.11/library/venv.html)

## 1.5段階目
1段階目の方法を若干改善して共有しました。
変更点は以下です。

- ビルド用と開発用でrequirementsを分ける
- ビルド用のrequirementsを開発用で継承するようにする
- requirementsフォルダを作成
- 仮想環境のプロンプト表示名を指定

実行ファイルのサイズを小さくすることと、様々なプロジェクト間を行き来することを考慮して行なった改善です。

```md
~~前略~~
# 仮想環境
## 作成
py -3.x -m venv .venv --prompt app_name

~~中略~~

## フォルダ構成

requirements
├─common.txt  # ビルド用
├─common.lock
├─dev.txt  # 開発用
└─dev.lock

~~後略~~

```

## 2段階目
上長には事前にuvの存在とできることの共有はしていて、非常に好感触でした。
また、前段までに作成したREADMEやvenvとrequirements使用した管理方法も、お目通し、お試しいただいて、こちらも良さそうというフィードバックをもらっていました。

ということで、満を持してuvの環境を作成します。

といってもuvが便利すぎて、READMEに書くことは「uvインストールしてね、あとはuvの方で大体自動でやってくれるよ」程度しかありません。
Pythonやライブラリのバージョン等については、`.python-version`や`pyproject.toml`、`uv.lock`などに基本自動で記載されます。

あとは念のため、uvに慣れていない人が使いやすいように、基本的な使い方を`docs/uv.md`として置くようにしています。
公式に書いてあるよく使うコマンドを日本語にしつつまとめただけなので、こちらの例も省略します。

# uvの良さ

「Rustで書かれていて早い」というのが、uvの最もわかりやすく、よく知られた特徴かと思います。
今般の課題感としては、以下の点ですごく良さを感じました。

1. Pythonのバージョン管理
  - `.python-version`や`pyproject.toml`でPythonバージョンを明示できる
  - Python自体のバージョンもuvで管理できる
上記2点及びその相互作用に非常に良さを感じました。

2. 依存関係、仮想環境の管理
  - `uv add`することで`pyproject.toml`に記載、仮想環境へのインストール、lockの更新までやってくれる
  - 依存関係をグルーピングできる
  - 仮想環境が有効になっているかどうかを意識する必要がない
  - lockと仮想環境の状態を自動で同期してくれる
など枚挙にいとまがありません。

また、個人的に公式ドキュメントが良質という点に良さを感じました。
良質とする基準をどこに置くかは、人によって違うと思いますが、
- 使えるコマンドやオプションが説明付きで網羅敵に載っている
- 例が豊富
あたりが、個人的な評価ポイントです。
